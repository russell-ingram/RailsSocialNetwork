<%= render "layouts/header" %>
<div class="pageWrap">

  <div class="messagesHeader">
    <div class="pageHeader">Messages</div>
  </div>

  <div class="replyFormWrapper newMessagesFormWrapper">
    <div class="replyFormHeader formHeader"><a href="/messages"><i class="fa fa-chevron-left"></i> INBOX</a></div>


<!-- start message -->
  <% @messages.reverse.each_with_index do |message, index| %>
    <% sender = message.sender %>
    <% send_pos = sender.current_pos %>

    <% if index > 0 %>
    <div class="replyFormBody hiddenReply">
    <% else %>
    <div class="replyFormBody">
    <% end %>
      <div class="replyPicColumn">
        <div class="replyPic">
          <% if sender.profile_pic_url? %>
            <%= image_tag sender.profile_pic_url %>
          <% else %>
          <%= image_tag("avatar-icons/avatar_0"+rand(1..9).to_s+".svg") %>
          <% end %>
        </div>

      </div>
      <div class="replyContentColumn">
        <div class="replyToFrom">
          <div class="replyFrom">
            From: <div class="messageName replyName">
            <a href="/profile/<%= sender.id %>">
              <%= sender.full_name %>
            </a>
            </div><div class="senderInfo"><%= send_pos.job_title %> at <%= send_pos.company %></div>
          </div>
          <div class="replyTo">
            To: <div class="senderInfo sendersInfoDiv">
              <div class="toDiv">me,</div>
              <% recipients = message.recipients %>
              <% if recipients[recipients.length-1] == current_user %>
                <% atTheEnd = true %>
              <% else %>
                <% atTheEnd = false %>
              <% end %>
              <% recipients.each_with_index do |u,i| %>
                <% if i == (recipients.length - 1) %>

                  <% if u != current_user %>
                    <a href="/profile/<%= u.id %>" class="userReplyLink">
                    <%= u.full_name %>
                    </a>
                  <% end %>

                <% else %>
                  <% if u != current_user %>

                    <% if i == (recipients.length - 2) %>
                      <% if atTheEnd %>
                        <a href="/profile/<%= u.id %>" class="userReplyLink">
                        <%= u.full_name %>
                        </a>
                      <% else %>
                        <a href="/profile/<%= u.id %>" class="userReplyLink">
                        <%= u.full_name %>
                        </a>, <div class="toDiv"> and</div>
                      <% end %>
                    <% else %>
                      <a href="/profile/<%= u.id %>" class="userReplyLink">
                      <%= u.full_name %>
                      </a>
                    <% end %>

                  <% end %>

                <% end %>
                <!-- end loop -->
              <% end %>
            </div>
          </div>
        </div>
        <div class="replyTimeStamp">
          <div class="timeStampTime senderInfo">
            <%= message.created_at.strftime("%l:%M %P") %>
          </div>
          <div class="timeStampDate">
            <%= message.created_at.strftime("%B %-d, %Y") %>
          </div>
        </div>
        <div class="replySubject"><%= @conversation.subject %></div>
        <div class="replyBody"><%= simple_format(message.body).html_safe %></div>

      <% if index > 0 %>

      <% else %>
        <div class="replyButton">
          REPLY
        </div>
        <div class="otherOptions">
          <div class="showAllMessages">
            <div class="sft">SHOW FULL THREAD </div> <div class="numMessages"> <%= @conversation.count_messages %> MESSAGES</div>
          </div>
          <div class="deleteMessage">
          <%= link_to "DELETE", delete_conversation_path(@conversation), method: :post %>

          </div>
        </div>
      <% end %>



      </div>



      </div>
      <% end %>
<!-- end messages -->




  </div>

<!-- replyformwrapper end -->

    <div class="newMessagesFormWrapper replyForm">

      <div class="newMsgForm formBox">

      <div class="newMsgFormHeader formHeader">REPLY</div>



    <%= form_tag reply_conversation_path(@conversation), method: :post do %>


      <div class="replyMsgFormGroup">
        <div class="toDiv">TO: </div>
              <% if @recipients[@recipients.length-1] == current_user %>
                <% atTheEnd = true %>
              <% else %>
                <% atTheEnd = false %>
              <% end %>


              <% @recipients.each_with_index do |u,i| %>
                <% if i == (@recipients.length - 1) %>

                  <% if u != current_user %>
                    <a href="/profile/<%= u.id %>" class="userReplyLink">
                    <%= u.full_name %>
                    </a>
                  <% end %>

                <% else %>
                  <% if u != current_user %>

                    <% if i == (@recipients.length - 2) %>
                      <% if atTheEnd %>
                        <a href="/profile/<%= u.id %>" class="userReplyLink">
                        <%= u.full_name %>
                        </a>
                      <% else %>
                        <a href="/profile/<%= u.id %>" class="userReplyLink">
                        <%= u.full_name %>
                        </a>,
                      <% end %>
                    <% else %>
                      <a href="/profile/<%= u.id %>" class="userReplyLink">
                      <%= u.full_name %>
                      </a>
                    <% end %>

                  <% end %>

                <% end %>
                <!-- end loop -->
              <% end %>

      </div>

      <div class="newMsgFormGroup">
        <%= text_area_tag 'body', nil, cols: 3, class: 'newMsgFormControl newMessageArea', required: true %>
      </div>

      <div class="newMsgBtnSend">
        <span>
          <span>
              <input type="Submit" value="Send">
          </span>
        </span>
       </div>

    <% end %>





      </div>






    </div>




  <div class="footerMargin"></div>
</div>

<%= render "layouts/footer" %>
